# 自動化系統修復腳本 - 使用指南

## 🎯 概述

`auto_repair_system.sh` 是一個全面的系統維護和修復腳本，專門為 LINE Bot 失智症分析系統設計。該腳本能夠自動檢測和修復常見的系統問題，確保系統穩定運行。

## 🚀 功能特性

### 核心功能
- ✅ **端口管理**: 自動檢測和釋放被佔用的端口 (8000, 5000, 3000)
- ✅ **目錄管理**: 創建和維護必要的系統目錄
- ✅ **日誌清理**: 自動清理舊的日誌文件，防止磁盤空間不足
- ✅ **虛擬環境修復**: 檢測和修復 Python 虛擬環境問題
- ✅ **系統資源監控**: 監控內存和磁盤使用情況
- ✅ **文件權限修復**: 自動修復文件和目錄權限
- ✅ **進程管理**: 檢測和清理殭屍進程

### 兼容性
- ✅ **macOS**: 完全兼容 macOS 系統
- ✅ **Linux**: 支持 Linux 系統
- ✅ **跨平台**: 自動檢測操作系統並使用相應的命令

## 📋 使用方法

### 基本用法

```bash
# 執行標準修復
./auto_repair_system.sh

# 快速修復（僅端口清理和目錄創建）
./auto_repair_system.sh --quick

# 深度修復（包含虛擬環境重建）
./auto_repair_system.sh --deep

# 僅檢查系統狀態
./auto_repair_system.sh --check

# 顯示幫助信息
./auto_repair_system.sh --help
```

### 修復模式說明

#### 1. 標準修復模式
執行完整的系統修復流程：
- 創建必要目錄
- 清理端口佔用
- 清理舊日誌文件
- 修復虛擬環境
- 檢查系統資源
- 修復文件權限
- 生成修復報告

#### 2. 快速修復模式
執行緊急修復操作：
- 清理端口佔用
- 創建必要目錄
- 清理舊日誌文件

#### 3. 深度修復模式
執行全面的系統重建：
- 包含標準修復的所有步驟
- 清理 Python 緩存文件
- 重建虛擬環境
- 重新安裝依賴包

#### 4. 檢查模式
僅檢查系統狀態，不執行修復：
- 檢查 Python 進程
- 檢查系統資源
- 驗證系統狀態

## 🔧 修復項目詳解

### 1. 端口管理
```bash
# 檢查的端口
ports=(8000 5000 3000)

# 處理流程
1. 檢測端口佔用情況
2. 嘗試優雅終止進程 (SIGTERM)
3. 等待 3 秒
4. 強制終止進程 (SIGKILL)
```

### 2. 目錄管理
```bash
# 創建的目錄
directories=(
    "logs"      # 日誌目錄
    "temp"      # 臨時文件目錄
    "backup"    # 備份目錄
    "data"      # 數據目錄
)
```

### 3. 日誌清理
```bash
# 清理規則
- 刪除 7 天前的日誌文件
- 截斷大於 10MB 的日誌文件
- 保留最新的日誌記錄
```

### 4. 虛擬環境修復
```bash
# 修復流程
1. 檢查虛擬環境是否存在
2. 嘗試激活虛擬環境
3. 如果激活失敗，重建虛擬環境
4. 升級 pip, setuptools, wheel
5. 安裝 requirements.txt 中的依賴
```

### 5. 系統資源監控
```bash
# macOS 內存檢查
vm_stat | grep "Pages free"

# Linux 內存檢查
free | grep Mem

# 磁盤空間檢查
df / | tail -1
```

## 📊 輸出示例

### 標準修復輸出
```
[INFO] 開始系統自動修復...
==================================
[INFO] 檢查端口佔用情況...
[WARNING] 端口 8000 被進程 50341 佔用
[INFO] 嘗試優雅終止進程 50341...
[SUCCESS] 端口 8000 已釋放
[INFO] 創建必要的目錄...
[SUCCESS] 創建目錄: temp
[INFO] 清理舊的日誌文件...
[SUCCESS] 日誌清理完成
[INFO] 檢查虛擬環境...
[SUCCESS] 虛擬環境檢查完成
[INFO] 檢查 Python 進程...
[INFO] 發現 5 個 Python 進程
[INFO] 檢查系統資源...
[INFO] 內存使用率: 85.2%
[INFO] 磁盤使用率: 58%
[INFO] 修復文件權限...
[SUCCESS] 文件權限修復完成
[INFO] 驗證系統狀態...
[SUCCESS] 系統狀態驗證通過
[SUCCESS] 系統修復完成！
[INFO] 生成修復報告: logs/repair_report_20250801_145730.txt
```

### 檢查模式輸出
```
[INFO] 檢查系統狀態...
[INFO] 檢查 Python 進程...
[INFO] 發現 5 個 Python 進程
[INFO] 檢查系統資源...
[INFO] 內存使用率: 85.2%
[WARNING] 內存使用率過高: 85.2%
[INFO] 磁盤使用率: 58%
[INFO] 驗證系統狀態...
[SUCCESS] 系統狀態驗證通過
[INFO] 系統檢查完成
```

## 📝 修復報告

腳本會自動生成詳細的修復報告，包含：

### 報告內容
- 修復時間和腳本版本
- 執行的修復項目列表
- 系統狀態信息
- Python 版本和環境信息
- 磁盤和內存使用情況
- 運行中的 Python 進程數量
- 修復結果（成功/部分失敗）

### 報告位置
```
logs/repair_report_YYYYMMDD_HHMMSS.txt
```

### 報告示例
```
系統修復報告
==============
修復時間: Thu Aug  1 14:57:30 CST 2025
修復腳本版本: 1.0

修復項目:
- 創建必要目錄
- 清理端口佔用
- 清理舊日誌文件
- 修復虛擬環境
- 檢查系統資源
- 修復文件權限

系統狀態:
- Python 版本: Python 3.13.0
- 磁盤使用: 58%
- 內存使用: 85.2%
- 運行進程: 5 個 Python 進程

修復結果: 成功
```

## ⚠️ 注意事項

### 安全提醒
1. **Root 權限**: 腳本會檢測是否以 root 用戶運行並發出警告
2. **進程終止**: 腳本會終止佔用端口的進程，請確保沒有重要數據
3. **虛擬環境**: 深度修復會重建虛擬環境，請備份重要配置

### 兼容性說明
1. **macOS**: 使用 `vm_stat` 和 `sysctl` 檢查內存
2. **Linux**: 使用 `free` 命令檢查內存
3. **錯誤處理**: 所有命令都有錯誤處理，不會因單個命令失敗而中斷

### 性能影響
1. **端口清理**: 會終止相關進程，可能影響正在運行的服務
2. **虛擬環境重建**: 需要重新安裝依賴包，可能需要幾分鐘
3. **日誌清理**: 只清理舊文件，不會影響當前運行

## 🔄 自動化集成

### 定時任務設置
```bash
# 添加到 crontab
# 每天凌晨 2 點執行標準修復
0 2 * * * /path/to/auto_repair_system.sh

# 每小時檢查系統狀態
0 * * * * /path/to/auto_repair_system.sh --check
```

### 系統啟動腳本
```bash
#!/bin/bash
# 系統啟動時執行快速修復
/path/to/auto_repair_system.sh --quick
```

## 🛠️ 故障排除

### 常見問題

#### 1. 權限問題
```bash
# 解決方案：給腳本執行權限
chmod +x auto_repair_system.sh
```

#### 2. 端口無法釋放
```bash
# 手動檢查端口佔用
lsof -i :8000

# 手動終止進程
kill -9 <PID>
```

#### 3. 虛擬環境問題
```bash
# 手動重建虛擬環境
rm -rf venv
python3 -m venv venv
source venv/bin/activate
pip install -r requirements.txt
```

#### 4. 內存使用率過高
```bash
# 檢查內存使用
top -l 1 | grep PhysMem

# 清理系統緩存
sudo purge
```

## 📈 性能優化

### 腳本優化建議
1. **並行處理**: 可以將某些修復步驟並行執行
2. **增量修復**: 只修復有問題的部分
3. **智能檢測**: 根據系統狀態決定是否需要修復

### 系統優化建議
1. **定期清理**: 設置定時任務定期執行修復
2. **監控告警**: 結合監控系統，在問題出現時自動修復
3. **備份策略**: 在深度修復前自動備份重要數據

## 🎉 總結

`auto_repair_system.sh` 是一個功能強大、兼容性好的系統維護工具，能夠：

1. **自動化維護**: 減少手動維護工作
2. **問題預防**: 在問題出現前進行修復
3. **系統穩定**: 確保 LINE Bot 系統穩定運行
4. **詳細記錄**: 提供完整的修復記錄和報告

通過合理使用這個腳本，可以大大降低系統維護成本，提高系統可靠性。

---

**版本**: 1.0  
**最後更新**: 2025-08-01  
**狀態**: ✅ 生產就緒 